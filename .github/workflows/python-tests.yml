name: Python Tests

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: |
          python -m pip install --upgrade pip
          python -m pip install .
      - name: Start streamable HTTP server
        run: |
          export ALLOWED_DIR="${GITHUB_WORKSPACE}"
          export ALLOWED_COMMANDS="all"
          export ALLOWED_FLAGS="all"
          export ALLOW_SHELL_OPERATORS="true"
          export MCP_HTTP_HOST="127.0.0.1"
          export MCP_HTTP_PORT="8084"
          export MCP_HTTP_PATH="/mcp"
          cli-mcp-server-http >streamable-http.log 2>&1 &
          echo $! > streamable-http.pid
      - name: Wait for streamable HTTP server
        run: |
          python - <<'PY'
          import socket
          import time

          host, port = "127.0.0.1", 8084
          deadline = time.time() + 30
          while time.time() < deadline:
              try:
                  with socket.create_connection((host, port), timeout=1):
                      break
              except OSError:
                  time.sleep(1)
          else:
              raise SystemExit("Streamable HTTP server did not start on 127.0.0.1:8084")
          PY
      - run: python -m unittest discover -v
