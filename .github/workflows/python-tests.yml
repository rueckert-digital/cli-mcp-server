name: Python Tests

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: |
          python -m pip install --upgrade pip
          python -m pip install .
      - name: Start Supergateway
        run: |
          export ALLOWED_DIR="${GITHUB_WORKSPACE}"
          export ALLOWED_COMMANDS="all"
          export ALLOWED_FLAGS="all"
          export ALLOW_SHELL_OPERATORS="true"
          npx -y supergateway \
            --stdio "cli-mcp-server" \
            --outputTransport streamableHttp \
            --stateful \
            --port 8084 \
            --streamableHttpPath /mcp >supergateway.log 2>&1 &
          echo $! > supergateway.pid
      - name: Wait for Supergateway
        run: |
          python - <<'PY'
          import socket
          import time

          host, port = "127.0.0.1", 8084
          deadline = time.time() + 30
          while time.time() < deadline:
              try:
                  with socket.create_connection((host, port), timeout=1):
                      break
              except OSError:
                  time.sleep(1)
          else:
              raise SystemExit("Supergateway did not start on 127.0.0.1:8084")
          PY
      - run: python -m unittest discover -v
